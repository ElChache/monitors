{"version":3,"file":"rateLimit-RwK8U2L8.js","sources":["../../../.svelte-kit/adapter-node/chunks/rateLimit.js"],"sourcesContent":["import { Redis } from \"ioredis\";\nimport { config } from \"dotenv\";\nconfig();\nconst redis = new Redis({\n  host: process.env.REDIS_HOST || \"localhost\",\n  port: parseInt(process.env.REDIS_PORT || \"6379\"),\n  retryDelayOnFailover: 100,\n  enableOfflineQueue: false,\n  maxRetriesPerRequest: 3\n});\nredis.on(\"error\", (err) => {\n  console.error(\"Redis rate limiting error:\", err);\n});\nasync function rateLimit(options) {\n  const { identifier, limit, window, type } = options;\n  const key = `ratelimit:${type}:${identifier}`;\n  try {\n    const pipeline = redis.pipeline();\n    const now = Date.now();\n    const windowStart = now - window * 1e3;\n    pipeline.zremrangebyscore(key, 0, windowStart);\n    pipeline.zcard(key);\n    pipeline.zadd(key, now, `${now}-${Math.random()}`);\n    pipeline.expire(key, window);\n    const results = await pipeline.exec();\n    if (!results) {\n      throw new Error(\"Pipeline execution failed\");\n    }\n    const currentCount = results[1][1];\n    const resetTime = now + window * 1e3;\n    if (currentCount >= limit) {\n      return {\n        allowed: false,\n        remaining: 0,\n        resetTime,\n        retryAfter: Math.ceil(window)\n      };\n    }\n    return {\n      allowed: true,\n      remaining: Math.max(0, limit - currentCount - 1),\n      resetTime\n    };\n  } catch (error) {\n    console.error(`Rate limiting error for ${type}:`, error);\n    return {\n      allowed: true,\n      remaining: limit - 1,\n      resetTime: Date.now() + window * 1e3\n    };\n  }\n}\nasync function checkAuthLimit(identifier) {\n  return rateLimit({\n    identifier,\n    limit: 5,\n    // 5 attempts\n    window: 15 * 60,\n    // 15 minutes\n    type: \"auth_attempt\"\n  });\n}\nexport {\n  checkAuthLimit as c,\n  rateLimit as r\n};\n"],"names":[],"mappings":"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"}