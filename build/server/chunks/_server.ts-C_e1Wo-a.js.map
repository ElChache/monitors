{"version":3,"file":"_server.ts-C_e1Wo-a.js","sources":["../../../.svelte-kit/adapter-node/entries/endpoints/api/monitors/_id_/refresh/_server.ts.js"],"sourcesContent":["import { json } from \"@sveltejs/kit\";\nimport \"../../../../../../chunks/db.js\";\nimport \"../../../../../../chunks/users.js\";\nimport \"puppeteer\";\nimport \"../../../../../../chunks/service4.js\";\nimport \"../../../../../../chunks/evaluation_service.js\";\nimport { M as MonitorService } from \"../../../../../../chunks/monitor_service.js\";\nimport { g as getRedisClient } from \"../../../../../../chunks/redis.js\";\nimport { A as AuthService } from \"../../../../../../chunks/service2.js\";\nclass RateLimiter {\n  config;\n  constructor(config) {\n    this.config = config;\n  }\n  /**\n   * Check if request is within rate limit\n   */\n  async checkLimit(userId, ip, endpoint) {\n    const key = this.generateKey(userId, ip, endpoint);\n    const now = Date.now();\n    const windowStart = now - this.config.windowMs;\n    try {\n      const redis = await getRedisClient();\n      const pipe = redis.pipeline();\n      pipe.zremrangebyscore(key, \"-inf\", windowStart);\n      pipe.zcard(key);\n      pipe.zadd(key, now, `${now}-${Math.random()}`);\n      pipe.expire(key, Math.ceil(this.config.windowMs / 1e3));\n      const results = await pipe.exec();\n      if (!results) {\n        throw new Error(\"Redis pipeline execution failed\");\n      }\n      const currentRequests = results[1][1] || 0;\n      const allowed = currentRequests < this.config.maxRequests;\n      if (!allowed) {\n        await redis.zpopmax(key);\n      }\n      const resetTime = new Date(now + this.config.windowMs);\n      const remaining = Math.max(0, this.config.maxRequests - currentRequests - (allowed ? 1 : 0));\n      return {\n        allowed,\n        remaining,\n        resetTime,\n        totalRequests: currentRequests + (allowed ? 1 : 0),\n        windowMs: this.config.windowMs\n      };\n    } catch (error) {\n      console.error(\"Rate limiting error:\", error);\n      return {\n        allowed: true,\n        remaining: this.config.maxRequests - 1,\n        resetTime: new Date(now + this.config.windowMs),\n        totalRequests: 1,\n        windowMs: this.config.windowMs\n      };\n    }\n  }\n  /**\n   * Generate cache key for rate limiting\n   */\n  generateKey(userId, ip, endpoint) {\n    if (this.config.keyGenerator) {\n      return `rate_limit:${this.config.keyGenerator(userId, ip)}`;\n    }\n    const parts = [\"rate_limit\"];\n    if (userId) {\n      parts.push(`user:${userId}`);\n    }\n    if (ip) {\n      parts.push(`ip:${ip}`);\n    }\n    if (endpoint) {\n      parts.push(`endpoint:${endpoint}`);\n    }\n    return parts.join(\":\");\n  }\n  /**\n   * Reset rate limit for a specific key\n   */\n  async resetLimit(userId, ip, endpoint) {\n    const key = this.generateKey(userId, ip, endpoint);\n    try {\n      const redis = await getRedisClient();\n      await redis.del(key);\n    } catch (error) {\n      console.error(\"Error resetting rate limit:\", error);\n    }\n  }\n  /**\n   * Get current rate limit status without incrementing\n   */\n  async getStatus(userId, ip, endpoint) {\n    const key = this.generateKey(userId, ip, endpoint);\n    const now = Date.now();\n    const windowStart = now - this.config.windowMs;\n    try {\n      const redis = await getRedisClient();\n      await redis.zremrangebyscore(key, \"-inf\", windowStart);\n      const currentRequests = await redis.zcard(key);\n      const resetTime = new Date(now + this.config.windowMs);\n      const remaining = Math.max(0, this.config.maxRequests - currentRequests);\n      const allowed = currentRequests < this.config.maxRequests;\n      return {\n        allowed,\n        remaining,\n        resetTime,\n        totalRequests: currentRequests,\n        windowMs: this.config.windowMs\n      };\n    } catch (error) {\n      console.error(\"Rate limiting status error:\", error);\n      return {\n        allowed: true,\n        remaining: this.config.maxRequests,\n        resetTime: new Date(now + this.config.windowMs),\n        totalRequests: 0,\n        windowMs: this.config.windowMs\n      };\n    }\n  }\n}\nconst userDailyLimiter = new RateLimiter({\n  windowMs: 24 * 60 * 60 * 1e3,\n  // 24 hours\n  maxRequests: 50,\n  keyGenerator: (userId) => `daily:user:${userId}`\n});\nasync function POST({ params, request, getClientAddress }) {\n  try {\n    const authHeader = request.headers.get(\"authorization\");\n    if (!authHeader?.startsWith(\"Bearer \")) {\n      return json({ error: \"Authentication required\" }, { status: 401 });\n    }\n    const token = authHeader.substring(7);\n    const user = await AuthService.getCurrentUser(token);\n    if (!user) {\n      return json({ error: \"Invalid token\" }, { status: 401 });\n    }\n    const monitorId = params.id;\n    if (!monitorId) {\n      return json({ error: \"Monitor ID required\" }, { status: 400 });\n    }\n    const ip = getClientAddress();\n    const rateLimitResult = await userDailyLimiter.checkLimit(user.id, ip, \"manual_refresh\");\n    if (!rateLimitResult.allowed) {\n      return json(\n        {\n          error: \"Daily manual refresh limit exceeded\",\n          message: \"You have reached your daily limit of 50 manual refreshes. Automatic monitoring continues as scheduled.\",\n          limit: 50,\n          remaining: rateLimitResult.remaining,\n          resetTime: rateLimitResult.resetTime.toISOString(),\n          nextReset: rateLimitResult.resetTime\n        },\n        {\n          status: 429,\n          headers: {\n            \"X-RateLimit-Limit\": \"50\",\n            \"X-RateLimit-Remaining\": rateLimitResult.remaining.toString(),\n            \"X-RateLimit-Reset\": Math.ceil(rateLimitResult.resetTime.getTime() / 1e3).toString(),\n            \"Retry-After\": Math.ceil(rateLimitResult.windowMs / 1e3).toString()\n          }\n        }\n      );\n    }\n    const monitor = await MonitorService.getMonitor(monitorId, user.id);\n    if (!monitor) {\n      return json({ error: \"Monitor not found\" }, { status: 404 });\n    }\n    const { MonitorEvaluationService } = await import(\"../../../../../../chunks/index.js\");\n    const evaluationResult = await MonitorEvaluationService.evaluateMonitor(\n      monitorId,\n      `manual-${Date.now()}`\n    );\n    return json({\n      success: true,\n      message: \"Monitor refreshed successfully\",\n      evaluation: {\n        success: evaluationResult.success,\n        triggered: evaluationResult.triggered,\n        previousValue: evaluationResult.previousValue,\n        currentValue: evaluationResult.currentValue,\n        processingTime: evaluationResult.processingTime,\n        evaluatedAt: (/* @__PURE__ */ new Date()).toISOString()\n      },\n      rateLimit: {\n        remaining: rateLimitResult.remaining - 1,\n        // Account for this request\n        limit: 50,\n        resetTime: rateLimitResult.resetTime.toISOString(),\n        window: \"24 hours\"\n      },\n      monitor: {\n        id: monitor.id,\n        name: monitor.name,\n        lastEvaluated: (/* @__PURE__ */ new Date()).toISOString(),\n        status: monitor.isActive ? \"active\" : \"inactive\"\n      }\n    });\n  } catch (error) {\n    console.error(\"Manual refresh error:\", error);\n    return json(\n      { error: \"Internal server error\" },\n      { status: 500 }\n    );\n  }\n}\nexport {\n  POST\n};\n"],"names":[],"mappings":"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"}