{"version":3,"file":"_server.ts-BJCB4Pyb.js","sources":["../../../.svelte-kit/adapter-node/entries/endpoints/api/email/unsubscribe/_server.ts.js"],"sourcesContent":["import { error, redirect, json } from \"@sveltejs/kit\";\nimport { z } from \"zod\";\nimport { a as EmailTrackingService } from \"../../../../../chunks/templates.js\";\nconst unsubscribeSchema = z.object({\n  token: z.string().min(1, \"Unsubscribe token is required\")\n});\nconst GET = async ({ url }) => {\n  try {\n    const token = url.searchParams.get(\"token\");\n    if (!token) {\n      throw error(400, \"Missing unsubscribe token\");\n    }\n    const parsed = EmailTrackingService.parseUnsubscribeToken(token);\n    if (!parsed) {\n      throw error(400, \"Invalid unsubscribe token\");\n    }\n    const success = await EmailTrackingService.unsubscribe(\n      parsed.userId,\n      parsed.notificationType\n    );\n    if (!success) {\n      throw error(500, \"Failed to process unsubscribe request\");\n    }\n    const baseUrl = process.env.APP_URL || \"https://monitors.app\";\n    throw redirect(302, `${baseUrl}/unsubscribed?type=${parsed.notificationType}`);\n  } catch (err) {\n    console.error(\"Unsubscribe error:\", err);\n    if (err && typeof err === \"object\" && \"status\" in err) {\n      throw err;\n    }\n    throw error(500, \"Failed to process unsubscribe request\");\n  }\n};\nconst POST = async ({ request }) => {\n  try {\n    const data = await request.json();\n    const { token } = unsubscribeSchema.parse(data);\n    const parsed = EmailTrackingService.parseUnsubscribeToken(token);\n    if (!parsed) {\n      throw error(400, \"Invalid unsubscribe token\");\n    }\n    const success = await EmailTrackingService.unsubscribe(\n      parsed.userId,\n      parsed.notificationType\n    );\n    if (!success) {\n      throw error(500, \"Failed to process unsubscribe request\");\n    }\n    return json({\n      success: true,\n      message: \"Successfully unsubscribed from notifications\",\n      notificationType: parsed.notificationType\n    });\n  } catch (err) {\n    console.error(\"Unsubscribe API error:\", err);\n    if (err instanceof z.ZodError) {\n      throw error(400, {\n        message: \"Invalid request data\",\n        details: err.errors\n      });\n    }\n    if (err && typeof err === \"object\" && \"status\" in err) {\n      throw err;\n    }\n    throw error(500, \"Failed to process unsubscribe request\");\n  }\n};\nexport {\n  GET,\n  POST\n};\n"],"names":[],"mappings":"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"}