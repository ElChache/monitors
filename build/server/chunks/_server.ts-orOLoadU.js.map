{"version":3,"file":"_server.ts-orOLoadU.js","sources":["../../../.svelte-kit/adapter-node/entries/endpoints/api/monitors/test/_server.ts.js"],"sourcesContent":["import { json } from \"@sveltejs/kit\";\nimport { J as JWTService } from \"../../../../../chunks/jwt.js\";\nimport \"../../../../../chunks/db.js\";\nimport \"../../../../../chunks/users.js\";\nimport \"puppeteer\";\nimport \"../../../../../chunks/service4.js\";\nimport \"../../../../../chunks/evaluation_service.js\";\nimport { M as MonitorService } from \"../../../../../chunks/monitor_service.js\";\nimport { z } from \"zod\";\nconst TestMonitorSchema = z.object({\n  name: z.string().min(1).max(100),\n  prompt: z.string().min(10).max(1e3),\n  type: z.enum([\"state\", \"change\"]),\n  extractedFact: z.string().min(1).max(500),\n  triggerCondition: z.string().min(1).max(500),\n  factType: z.enum([\"number\", \"string\", \"boolean\", \"object\"]),\n  checkFrequency: z.number().min(5).max(1440).optional().default(60)\n  // 5 minutes to 24 hours\n});\nconst POST = async ({ request, cookies }) => {\n  try {\n    const sessionToken = cookies.get(\"session\");\n    if (!sessionToken) {\n      return json({ error: \"Not authenticated\" }, { status: 401 });\n    }\n    const payload = JWTService.verifyAccessToken(sessionToken);\n    if (!payload.userId) {\n      return json({ error: \"Invalid session\" }, { status: 401 });\n    }\n    const data = await request.json();\n    const validatedData = TestMonitorSchema.parse(data);\n    console.log(`Testing monitor configuration for user ${payload.userId}`);\n    const testResult = await MonitorService.testMonitor(payload.userId, validatedData);\n    return json({\n      success: true,\n      message: \"Monitor configuration tested successfully\",\n      data: {\n        testResult: testResult.success,\n        extractedValue: testResult.extractedValue,\n        processingTime: testResult.processingTime,\n        error: testResult.error,\n        configuration: {\n          name: validatedData.name,\n          type: validatedData.type,\n          factType: validatedData.factType,\n          triggerCondition: validatedData.triggerCondition\n        }\n      }\n    });\n  } catch (error) {\n    console.error(\"Monitor test endpoint error:\", error);\n    if (error.message?.includes(\"expired\")) {\n      return json({ error: \"Session expired\" }, { status: 401 });\n    }\n    if (error.name === \"ZodError\") {\n      return json(\n        { error: \"Validation failed\", details: error.errors },\n        { status: 400 }\n      );\n    }\n    return json(\n      { error: \"Internal server error\" },\n      { status: 500 }\n    );\n  }\n};\nexport {\n  POST\n};\n"],"names":[],"mappings":";;;;;;;;;;;;;;;;;;;AASA,MAAM,iBAAiB,GAAG,CAAC,CAAC,MAAM,CAAC;AACnC,EAAE,IAAI,EAAE,CAAC,CAAC,MAAM,EAAE,CAAC,GAAG,CAAC,CAAC,CAAC,CAAC,GAAG,CAAC,GAAG,CAAC;AAClC,EAAE,MAAM,EAAE,CAAC,CAAC,MAAM,EAAE,CAAC,GAAG,CAAC,EAAE,CAAC,CAAC,GAAG,CAAC,GAAG,CAAC;AACrC,EAAE,IAAI,EAAE,CAAC,CAAC,IAAI,CAAC,CAAC,OAAO,EAAE,QAAQ,CAAC,CAAC;AACnC,EAAE,aAAa,EAAE,CAAC,CAAC,MAAM,EAAE,CAAC,GAAG,CAAC,CAAC,CAAC,CAAC,GAAG,CAAC,GAAG,CAAC;AAC3C,EAAE,gBAAgB,EAAE,CAAC,CAAC,MAAM,EAAE,CAAC,GAAG,CAAC,CAAC,CAAC,CAAC,GAAG,CAAC,GAAG,CAAC;AAC9C,EAAE,QAAQ,EAAE,CAAC,CAAC,IAAI,CAAC,CAAC,QAAQ,EAAE,QAAQ,EAAE,SAAS,EAAE,QAAQ,CAAC,CAAC;AAC7D,EAAE,cAAc,EAAE,CAAC,CAAC,MAAM,EAAE,CAAC,GAAG,CAAC,CAAC,CAAC,CAAC,GAAG,CAAC,IAAI,CAAC,CAAC,QAAQ,EAAE,CAAC,OAAO,CAAC,EAAE;AACnE;AACA,CAAC,CAAC;AACG,MAAC,IAAI,GAAG,OAAO,EAAE,OAAO,EAAE,OAAO,EAAE,KAAK;AAC7C,EAAE,IAAI;AACN,IAAI,MAAM,YAAY,GAAG,OAAO,CAAC,GAAG,CAAC,SAAS,CAAC;AAC/C,IAAI,IAAI,CAAC,YAAY,EAAE;AACvB,MAAM,OAAO,IAAI,CAAC,EAAE,KAAK,EAAE,mBAAmB,EAAE,EAAE,EAAE,MAAM,EAAE,GAAG,EAAE,CAAC;AAClE,IAAI;AACJ,IAAI,MAAM,OAAO,GAAG,UAAU,CAAC,iBAAiB,CAAC,YAAY,CAAC;AAC9D,IAAI,IAAI,CAAC,OAAO,CAAC,MAAM,EAAE;AACzB,MAAM,OAAO,IAAI,CAAC,EAAE,KAAK,EAAE,iBAAiB,EAAE,EAAE,EAAE,MAAM,EAAE,GAAG,EAAE,CAAC;AAChE,IAAI;AACJ,IAAI,MAAM,IAAI,GAAG,MAAM,OAAO,CAAC,IAAI,EAAE;AACrC,IAAI,MAAM,aAAa,GAAG,iBAAiB,CAAC,KAAK,CAAC,IAAI,CAAC;AACvD,IAAI,OAAO,CAAC,GAAG,CAAC,CAAC,uCAAuC,EAAE,OAAO,CAAC,MAAM,CAAC,CAAC,CAAC;AAC3E,IAAI,MAAM,UAAU,GAAG,MAAM,cAAc,CAAC,WAAW,CAAC,OAAO,CAAC,MAAM,EAAE,aAAa,CAAC;AACtF,IAAI,OAAO,IAAI,CAAC;AAChB,MAAM,OAAO,EAAE,IAAI;AACnB,MAAM,OAAO,EAAE,2CAA2C;AAC1D,MAAM,IAAI,EAAE;AACZ,QAAQ,UAAU,EAAE,UAAU,CAAC,OAAO;AACtC,QAAQ,cAAc,EAAE,UAAU,CAAC,cAAc;AACjD,QAAQ,cAAc,EAAE,UAAU,CAAC,cAAc;AACjD,QAAQ,KAAK,EAAE,UAAU,CAAC,KAAK;AAC/B,QAAQ,aAAa,EAAE;AACvB,UAAU,IAAI,EAAE,aAAa,CAAC,IAAI;AAClC,UAAU,IAAI,EAAE,aAAa,CAAC,IAAI;AAClC,UAAU,QAAQ,EAAE,aAAa,CAAC,QAAQ;AAC1C,UAAU,gBAAgB,EAAE,aAAa,CAAC;AAC1C;AACA;AACA,KAAK,CAAC;AACN,EAAE,CAAC,CAAC,OAAO,KAAK,EAAE;AAClB,IAAI,OAAO,CAAC,KAAK,CAAC,8BAA8B,EAAE,KAAK,CAAC;AACxD,IAAI,IAAI,KAAK,CAAC,OAAO,EAAE,QAAQ,CAAC,SAAS,CAAC,EAAE;AAC5C,MAAM,OAAO,IAAI,CAAC,EAAE,KAAK,EAAE,iBAAiB,EAAE,EAAE,EAAE,MAAM,EAAE,GAAG,EAAE,CAAC;AAChE,IAAI;AACJ,IAAI,IAAI,KAAK,CAAC,IAAI,KAAK,UAAU,EAAE;AACnC,MAAM,OAAO,IAAI;AACjB,QAAQ,EAAE,KAAK,EAAE,mBAAmB,EAAE,OAAO,EAAE,KAAK,CAAC,MAAM,EAAE;AAC7D,QAAQ,EAAE,MAAM,EAAE,GAAG;AACrB,OAAO;AACP,IAAI;AACJ,IAAI,OAAO,IAAI;AACf,MAAM,EAAE,KAAK,EAAE,uBAAuB,EAAE;AACxC,MAAM,EAAE,MAAM,EAAE,GAAG;AACnB,KAAK;AACL,EAAE;AACF;;;;"}