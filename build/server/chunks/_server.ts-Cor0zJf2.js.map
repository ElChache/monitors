{"version":3,"file":"_server.ts-Cor0zJf2.js","sources":["../../../.svelte-kit/adapter-node/entries/endpoints/api/monitors/_server.ts.js"],"sourcesContent":["import { error, json } from \"@sveltejs/kit\";\nimport { z } from \"zod\";\nimport \"../../../../chunks/db.js\";\nimport \"../../../../chunks/users.js\";\nimport \"puppeteer\";\nimport \"../../../../chunks/service4.js\";\nimport \"../../../../chunks/evaluation_service.js\";\nimport { M as MonitorService } from \"../../../../chunks/monitor_service.js\";\nimport { J as JWTService } from \"../../../../chunks/jwt.js\";\nconst createMonitorSchema = z.object({\n  name: z.string().min(1).max(100),\n  prompt: z.string().min(10).max(1e3),\n  type: z.enum([\"state\", \"change\"]),\n  extractedFact: z.string().min(1).max(500),\n  triggerCondition: z.string().min(1).max(500),\n  factType: z.enum([\"number\", \"string\", \"boolean\", \"object\"]),\n  checkFrequency: z.number().min(5).max(1440).optional().default(60)\n  // 5 minutes to 24 hours\n});\nconst listMonitorsSchema = z.object({\n  page: z.string().optional().transform((val) => val ? parseInt(val) : 1),\n  limit: z.string().optional().transform((val) => val ? parseInt(val) : 20),\n  active: z.string().optional().transform((val) => val === \"true\" ? true : val === \"false\" ? false : void 0)\n});\nconst GET = async ({ request, cookies, url }) => {\n  try {\n    const accessToken = cookies.get(\"access_token\");\n    if (!accessToken) {\n      throw error(401, \"Authentication required\");\n    }\n    const payload = JWTService.verifyAccessToken(accessToken);\n    if (!payload) {\n      throw error(401, \"Invalid session token\");\n    }\n    const queryParams = Object.fromEntries(url.searchParams);\n    const query = listMonitorsSchema.parse(queryParams);\n    const monitors = await MonitorService.getUserMonitors(payload.userId);\n    let filteredMonitors = monitors;\n    if (query.active !== void 0) {\n      filteredMonitors = monitors.filter((monitor) => monitor.isActive === query.active);\n    }\n    const start = (query.page - 1) * query.limit;\n    const end = start + query.limit;\n    const paginatedMonitors = filteredMonitors.slice(start, end);\n    const result = {\n      monitors: paginatedMonitors,\n      pagination: {\n        page: query.page,\n        limit: query.limit,\n        total: filteredMonitors.length,\n        hasMore: end < filteredMonitors.length\n      }\n    };\n    return json({\n      success: true,\n      data: result\n    });\n  } catch (err) {\n    console.error(\"Get monitors error:\", err);\n    if (err instanceof z.ZodError) {\n      throw error(400, {\n        message: \"Invalid query parameters\",\n        details: err.errors\n      });\n    }\n    if (err && typeof err === \"object\" && \"status\" in err) {\n      throw err;\n    }\n    throw error(500, \"Failed to retrieve monitors\");\n  }\n};\nconst POST = async ({ request, cookies }) => {\n  try {\n    const accessToken = cookies.get(\"access_token\");\n    if (!accessToken) {\n      throw error(401, \"Authentication required\");\n    }\n    const payload = JWTService.verifyAccessToken(accessToken);\n    if (!payload) {\n      throw error(401, \"Invalid session token\");\n    }\n    const data = await request.json();\n    const validatedData = createMonitorSchema.parse(data);\n    const currentMonitors = await MonitorService.getUserMonitors(payload.userId);\n    if (currentMonitors.length >= 50) {\n      throw error(429, {\n        message: \"Monitor limit reached\",\n        details: \"Maximum of 50 monitors allowed per user\"\n      });\n    }\n    const monitor = await MonitorService.createMonitor(payload.userId, validatedData);\n    return json({\n      success: true,\n      message: \"Monitor created successfully\",\n      data: monitor\n    }, { status: 201 });\n  } catch (err) {\n    console.error(\"Create monitor error:\", err);\n    if (err instanceof z.ZodError) {\n      throw error(400, {\n        message: \"Invalid monitor data\",\n        details: err.errors\n      });\n    }\n    if (err && typeof err === \"object\" && \"status\" in err) {\n      throw err;\n    }\n    throw error(500, \"Failed to create monitor\");\n  }\n};\nexport {\n  GET,\n  POST\n};\n"],"names":[],"mappings":"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"}